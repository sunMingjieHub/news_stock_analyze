name: è‚¡ç¥¨æ–°é—»è‡ªåŠ¨çˆ¬å–ä¸åˆ†æ

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ 9:00, 10:00, ..., 18:00ï¼‰
    - cron: '0 1-10 * * 1-5'  # UTCæ—¶é—´ 1:00-10:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ 9:00-18:00
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      sources:
        description: 'æ–°é—»æºï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: 'æ–°æµªè´¢ç»,ä¸œæ–¹è´¢å¯Œ,é›ªçƒ'
      notify_channels:
        description: 'é€šçŸ¥æ¸ é“ï¼ˆtelegram,wechat,email,allï¼‰'
        required: false
        default: 'all'

env:
  NODE_VERSION: '18'

jobs:
  crawl-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ‰§è¡Œæ–°é—»çˆ¬å–ï¼ˆè°ƒç”¨Vercel APIï¼‰
      run: |
        # ç›´æ¥è°ƒç”¨Verceléƒ¨ç½²çš„åç«¯APIè¿›è¡Œæ–°é—»çˆ¬å–
        RESPONSE=$(curl -s -X POST "${{ secrets.VERCEL_API_URL }}/api/news/crawl" \
          -H "Content-Type: application/json" \
          -d "{\"sources\": [${{ github.event.inputs.sources || '[\"æ–°æµªè´¢ç»\",\"ä¸œæ–¹è´¢å¯Œ\",\"é›ªçƒ\"]' }}]}")
        
        echo "çˆ¬å–ç»“æœ: $RESPONSE"
        echo "CRAWL_RESULT=$RESPONSE" >> $GITHUB_ENV

    - name: åˆ†ææ–°é—»å†…å®¹ï¼ˆè°ƒç”¨Vercel APIï¼‰
      run: |
        # è§£æçˆ¬å–ç»“æœå¹¶è°ƒç”¨Vercel APIè¿›è¡Œåˆ†æ
        CRAWL_DATA=$(echo '${{ env.CRAWL_RESULT }}' | jq -r '.results[] | select(.success == true) | .items[] | {title: .title, url: .url, content: "å¾…æå–", sourceCredibility: .credibility}' | jq -s '.')
        
        if [ "$(echo $CRAWL_DATA | jq length)" -gt 0 ]; then
          ANALYSIS_RESPONSE=$(curl -s -X POST "${{ secrets.VERCEL_API_URL }}/api/analysis/batch-analyze" \
            -H "Content-Type: application/json" \
            -d "{\"articles\": $CRAWL_DATA}")
          
          echo "åˆ†æç»“æœ: $ANALYSIS_RESPONSE"
          echo "ANALYSIS_RESULT=$ANALYSIS_RESPONSE" >> $GITHUB_ENV
        else
          echo "æ²¡æœ‰å¯åˆ†æçš„æ–°é—»å†…å®¹"
          echo "ANALYSIS_RESULT={\"success\":false,\"message\":\"æ— æ–°é—»å†…å®¹\"}" >> $GITHUB_ENV
        fi

    - name: å‘é€é€šçŸ¥ï¼ˆè°ƒç”¨Vercel APIï¼‰
      run: |
        NOTIFY_CHANNELS="${{ github.event.inputs.notify_channels || 'all' }}"
        
        # æ ¹æ®åˆ†æç»“æœå†³å®šæ˜¯å¦å‘é€é€šçŸ¥
        ANALYSIS_DATA=$(echo '${{ env.ANALYSIS_RESULT }}' | jq -r '.data')
        
        if [ "$ANALYSIS_DATA" != "null" ] && [ "$(echo $ANALYSIS_DATA | jq '.articles | length')" -gt 0 ]; then
          # æå–é‡è¦åˆ†æç»“æœï¼ˆæƒ…ç»ªå¼ºåº¦é«˜æˆ–é£é™©ç­‰çº§é«˜ï¼‰
          IMPORTANT_ANALYSIS=$(echo $ANALYSIS_DATA | jq -r '.articles[] | select(.success == true and (.analysis.sentimentStrength >= 7 or .analysis.riskLevel == "é«˜é£é™©")) | .analysis')
          
          if [ "$(echo $IMPORTANT_ANALYSIS | jq -s length)" -gt 0 ]; then
            # å‘é€é‡è¦åˆ†æé€šçŸ¥
            curl -s -X POST "${{ secrets.VERCEL_API_URL }}/api/notifications/alert" \
              -H "Content-Type: application/json" \
              -d "{
                \"title\": \"é‡è¦å¸‚åœºåˆ†ææŠ¥å‘Š\",
                \"message\": \"å‘ç°é‡è¦å¸‚åœºä¿¡å·ï¼Œè¯·åŠæ—¶æŸ¥çœ‹è¯¦ç»†åˆ†æ\",
                \"analysis_result\": $(echo $IMPORTANT_ANALYSIS | jq -s '. | first'),
                \"urgency\": \"high\"
              }"
          else
            # å‘é€å¸¸è§„åˆ†ææ€»ç»“
            MARKET_ANALYSIS=$(echo $ANALYSIS_DATA | jq -r '.marketAnalysis')
            curl -s -X POST "${{ secrets.VERCEL_API_URL }}/api/notifications/send" \
              -H "Content-Type: application/json" \
              -d "{
                \"message\": \"ğŸ“Š ä»Šæ—¥å¸‚åœºæƒ…ç»ªåˆ†æå®Œæˆ\\\\n\\\\næ€»ä½“æƒ…ç»ª: $(echo $MARKET_ANALYSIS | jq -r '.overallSentiment')\\\\nç½®ä¿¡åº¦: $(echo $MARKET_ANALYSIS | jq -r '.confidence * 100 | round')%\\\\nå»ºè®®: $(echo $MARKET_ANALYSIS | jq -r '.recommendation')\",
                \"channels\": [\"$NOTIFY_CHANNELS\"],
                \"priority\": \"normal\"
              }"
          fi
        else
          # å‘é€æ— é‡è¦å†…å®¹é€šçŸ¥
          curl -s -X POST "${{ secrets.VERCEL_API_URL }}/api/notifications/send" \
            -H "Content-Type: application/json" \
            -d "{
              \"message\": \"ğŸ“Š ä»Šæ—¥æ–°é—»çˆ¬å–å®Œæˆ\\\\n\\\\næœªå‘ç°é‡è¦å¸‚åœºä¿¡å·ï¼Œå¸‚åœºè¡¨ç°å¹³ç¨³ã€‚\",
              \"channels\": [\"$NOTIFY_CHANNELS\"],
              \"priority\": \"low\"
            }"
        fi

    - name: æµ‹è¯•é€šçŸ¥æ¸ é“è¿é€šæ€§
      run: |
        # æµ‹è¯•æ‰€æœ‰é€šçŸ¥æ¸ é“
        curl -s -X GET "${{ secrets.VERCEL_API_URL }}/api/notifications/test-connectivity" \
          -H "Content-Type: application/json"

    - name: ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
      if: always()
      run: |
        echo "=== è‚¡ç¥¨æ–°é—»åˆ†ææ‰§è¡ŒæŠ¥å‘Š ==="
        echo "æ‰§è¡Œæ—¶é—´: $(date)"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "æ–°é—»æº: ${{ github.event.inputs.sources || 'é»˜è®¤æº' }}"
        echo "é€šçŸ¥æ¸ é“: ${{ github.event.inputs.notify_channels || 'all' }}"
        echo ""
        echo "çˆ¬å–ç»“æœ:"
        echo '${{ env.CRAWL_RESULT }}' | jq '.'
        echo ""
        echo "åˆ†æç»“æœ:"
        echo '${{ env.ANALYSIS_RESULT }}' | jq '.'