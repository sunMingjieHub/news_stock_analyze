name: è‚¡ç¥¨æ–°é—»è‡ªåŠ¨çˆ¬å–ä¸åˆ†æ

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ 9:00, 10:00, ..., 18:00ï¼‰
    - cron: '0 1-10 * * 1-5'  # UTCæ—¶é—´ 1:00-10:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ 9:00-18:00
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      sources:
        description: 'æ–°é—»æºï¼ˆé€—å·åˆ†éš”ï¼‰'
        required: false
        default: 'æ–°æµªè´¢ç»,ä¸œæ–¹è´¢å¯Œ,é›ªçƒ'
      notify_channels:
        description: 'é€šçŸ¥æ¸ é“ï¼ˆtelegram,wechat,email,allï¼‰'
        required: false
        default: 'all'

env:
  NODE_VERSION: '18'

jobs:
  crawl-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥Vercel APIé…ç½®
      run: |
        if [ -z "${{ secrets.VERCEL_API_URL }}" ]; then
          echo "âŒ é”™è¯¯ï¼šVERCEL_API_URL secretæœªè®¾ç½®"
          echo "è¯·åœ¨GitHubä»“åº“çš„Settings â†’ Secrets and variables â†’ Actionsä¸­æ·»åŠ VERCEL_API_URL"
          echo "å€¼åº”ä¸ºä½ çš„Verceléƒ¨ç½²åœ°å€ï¼Œä¾‹å¦‚ï¼šhttps://your-app.vercel.app"
          exit 1
        else
          echo "âœ… Vercel APIåœ°å€é…ç½®æ­£ç¡®: ${{ secrets.VERCEL_API_URL }}"
        fi

    - name: æ‰§è¡Œæ–°é—»çˆ¬å–ï¼ˆè°ƒç”¨Vercel APIï¼‰
      run: |
        # æ£€æŸ¥APIåœ°å€æ˜¯å¦æœ‰æ•ˆ
        API_URL="${{ secrets.VERCEL_API_URL }}"
        if [[ ! "$API_URL" =~ ^https?:// ]]; then
          echo "âŒ é”™è¯¯ï¼šAPIåœ°å€æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä»¥http://æˆ–https://å¼€å¤´"
          echo "å½“å‰å€¼: $API_URL"
          exit 1
        fi
        
        echo "æ­£åœ¨è°ƒç”¨API: ${API_URL}/api/news/crawl"
        
        # ç›´æ¥è°ƒç”¨Verceléƒ¨ç½²çš„åç«¯APIè¿›è¡Œæ–°é—»çˆ¬å–
        RESPONSE=$(curl -s -w "%{http_code}" -X POST "${API_URL}/api/news/crawl" \
          -H "Content-Type: application/json" \
          -d "{\"sources\": [${{ github.event.inputs.sources || '[\"æ–°æµªè´¢ç»\",\"ä¸œæ–¹è´¢å¯Œ\",\"é›ªçƒ\"]' }}]}")
        
        # åˆ†ç¦»HTTPçŠ¶æ€ç å’Œå“åº”ä½“
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
        
        echo "HTTPçŠ¶æ€ç : $HTTP_CODE"
        echo "å“åº”å†…å®¹: $RESPONSE_BODY"
        
        if [ "$HTTP_CODE" -ne 200 ]; then
          echo "âŒ APIè°ƒç”¨å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
          echo "è¯·æ£€æŸ¥ï¼š"
          echo "1. Vercelåº”ç”¨æ˜¯å¦æ­£å¸¸éƒ¨ç½²"
          echo "2. APIåœ°å€æ˜¯å¦æ­£ç¡®"
          echo "3. åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ"
          exit 1
        fi
        
        echo "CRAWL_RESULT=$RESPONSE_BODY" >> $GITHUB_ENV

    - name: åˆ†ææ–°é—»å†…å®¹ï¼ˆè°ƒç”¨Vercel APIï¼‰
      run: |
        # è§£æçˆ¬å–ç»“æœå¹¶è°ƒç”¨Vercel APIè¿›è¡Œåˆ†æ
        API_URL="${{ secrets.VERCEL_API_URL }}"
        CRAWL_DATA=$(echo '${{ env.CRAWL_RESULT }}' | jq -r '.results[] | select(.success == true) | .items[] | {title: .title, url: .url, content: "å¾…æå–", sourceCredibility: .credibility}' | jq -s '.')
        
        if [ "$(echo $CRAWL_DATA | jq length)" -gt 0 ]; then
          echo "æ­£åœ¨åˆ†ææ–°é—»å†…å®¹..."
          ANALYSIS_RESPONSE=$(curl -s -w "%{http_code}" -X POST "${API_URL}/api/analysis/batch-analyze" \
            -H "Content-Type: application/json" \
            -d "{\"articles\": $CRAWL_DATA}")
          
          HTTP_CODE=$(echo "$ANALYSIS_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$ANALYSIS_RESPONSE" | head -n -1)
          
          echo "åˆ†æAPIçŠ¶æ€ç : $HTTP_CODE"
          echo "åˆ†æç»“æœ: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ åˆ†æAPIè°ƒç”¨å¤±è´¥"
            exit 1
          fi
          
          echo "ANALYSIS_RESULT=$RESPONSE_BODY" >> $GITHUB_ENV
        else
          echo "æ²¡æœ‰å¯åˆ†æçš„æ–°é—»å†…å®¹"
          echo "ANALYSIS_RESULT={\"success\":false,\"message\":\"æ— æ–°é—»å†…å®¹\"}" >> $GITHUB_ENV
        fi

    - name: å‘é€é€šçŸ¥ï¼ˆè°ƒç”¨Vercel APIï¼‰
      run: |
        API_URL="${{ secrets.VERCEL_API_URL }}"
        NOTIFY_CHANNELS="${{ github.event.inputs.notify_channels || 'all' }}"
        
        # æ ¹æ®åˆ†æç»“æœå†³å®šæ˜¯å¦å‘é€é€šçŸ¥
        ANALYSIS_DATA=$(echo '${{ env.ANALYSIS_RESULT }}' | jq -r '.data')
        
        if [ "$ANALYSIS_DATA" != "null" ] && [ "$(echo $ANALYSIS_DATA | jq '.articles | length')" -gt 0 ]; then
          # æå–é‡è¦åˆ†æç»“æœï¼ˆæƒ…ç»ªå¼ºåº¦é«˜æˆ–é£é™©ç­‰çº§é«˜ï¼‰
          IMPORTANT_ANALYSIS=$(echo $ANALYSIS_DATA | jq -r '.articles[] | select(.success == true and (.analysis.sentimentStrength >= 7 or .analysis.riskLevel == "é«˜é£é™©")) | .analysis')
          
          if [ "$(echo $IMPORTANT_ANALYSIS | jq -s length)" -gt 0 ]; then
            # å‘é€é‡è¦åˆ†æé€šçŸ¥
            echo "å‘é€é‡è¦åˆ†æé€šçŸ¥..."
            curl -s -X POST "${API_URL}/api/notifications/alert" \
              -H "Content-Type: application/json" \
              -d "{
                \"title\": \"é‡è¦å¸‚åœºåˆ†ææŠ¥å‘Š\",
                \"message\": \"å‘ç°é‡è¦å¸‚åœºä¿¡å·ï¼Œè¯·åŠæ—¶æŸ¥çœ‹è¯¦ç»†åˆ†æ\",
                \"analysis_result\": $(echo $IMPORTANT_ANALYSIS | jq -s '. | first'),
                \"urgency\": \"high\"
              }"
          else
            # å‘é€å¸¸è§„åˆ†ææ€»ç»“
            MARKET_ANALYSIS=$(echo $ANALYSIS_DATA | jq -r '.marketAnalysis')
            echo "å‘é€å¸¸è§„åˆ†æé€šçŸ¥..."
            curl -s -X POST "${API_URL}/api/notifications/send" \
              -H "Content-Type: application/json" \
              -d "{
                \"message\": \"ğŸ“Š ä»Šæ—¥å¸‚åœºæƒ…ç»ªåˆ†æå®Œæˆ\\\\n\\\\næ€»ä½“æƒ…ç»ª: $(echo $MARKET_ANALYSIS | jq -r '.overallSentiment')\\\\nç½®ä¿¡åº¦: $(echo $MARKET_ANALYSIS | jq -r '.confidence * 100 | round')%\\\\nå»ºè®®: $(echo $MARKET_ANALYSIS | jq -r '.recommendation')\",
                \"channels\": [\"$NOTIFY_CHANNELS\"],
                \"priority\": \"normal\"
              }"
          fi
        else
          # å‘é€æ— é‡è¦å†…å®¹é€šçŸ¥
          echo "å‘é€æ— é‡è¦å†…å®¹é€šçŸ¥..."
          curl -s -X POST "${API_URL}/api/notifications/send" \
            -H "Content-Type: application/json" \
            -d "{
              \"message\": \"ğŸ“Š ä»Šæ—¥æ–°é—»çˆ¬å–å®Œæˆ\\\\n\\\\næœªå‘ç°é‡è¦å¸‚åœºä¿¡å·ï¼Œå¸‚åœºè¡¨ç°å¹³ç¨³ã€‚\",
              \"channels\": [\"$NOTIFY_CHANNELS\"],
              \"priority\": \"low\"
            }"
        fi

    - name: æµ‹è¯•é€šçŸ¥æ¸ é“è¿é€šæ€§
      run: |
        # æµ‹è¯•APIè¿é€šæ€§
        API_URL="${{ secrets.VERCEL_API_URL }}"
        echo "æµ‹è¯•APIè¿é€šæ€§: ${API_URL}/health"
        
        HEALTH_RESPONSE=$(curl -s -w "%{http_code}" "${API_URL}/health")
        HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$HEALTH_RESPONSE" | head -n -1)
        
        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "âœ… APIæœåŠ¡æ­£å¸¸"
        else
          echo "âŒ APIæœåŠ¡å¼‚å¸¸ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
          echo "å“åº”: $RESPONSE_BODY"
        fi

    - name: ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š
      if: always()
      run: |
        echo "=== è‚¡ç¥¨æ–°é—»åˆ†ææ‰§è¡ŒæŠ¥å‘Š ==="
        echo "æ‰§è¡Œæ—¶é—´: $(date)"
        echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        echo "æ–°é—»æº: ${{ github.event.inputs.sources || 'é»˜è®¤æº' }}"
        echo "é€šçŸ¥æ¸ é“: ${{ github.event.inputs.notify_channels || 'all' }}"
        echo ""
        echo "çˆ¬å–ç»“æœ:"
        echo '${{ env.CRAWL_RESULT }}' | jq '.'
        echo ""
        echo "åˆ†æç»“æœ:"
        echo '${{ env.ANALYSIS_RESULT }}' | jq '.'